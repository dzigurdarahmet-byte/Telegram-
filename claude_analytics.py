"""
Claude AI –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö iiko
–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É
"""

import anthropic
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

SYSTEM_PROMPT = """–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å —Å–∏—Å—Ç–µ–º–æ–π iiko. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–æ—Å—Ç—ã–º –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º.

–¢–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
üìä –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ (–≤—ã—Ä—É—á–∫–∞, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤)
üçΩÔ∏è ABC-–∞–Ω–∞–ª–∏–∑ –±–ª—é–¥ (—á—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç—Å—è —Ö–æ—Ä–æ—à–æ, —á—Ç–æ –ø–ª–æ—Ö–æ)
üö´ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å—Ç–æ–ø-–ª–∏—Å—Ç—É
üë®‚Äçüç≥ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
üì¶ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ

–ü—Ä–∞–≤–∏–ª–∞:
1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.
2. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–≥–æ, —á—Ç–æ –µ—Å—Ç—å.
3. –ü—Ä–∏ ABC-–∞–Ω–∞–ª–∏–∑–µ:
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è A: —Ç–æ–ø-20% –ø–æ–∑–∏—Ü–∏–π, –¥–∞—é—â–∏—Ö 80% –≤—ã—Ä—É—á–∫–∏
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è B: —Å–ª–µ–¥—É—é—â–∏–µ 30%, –¥–∞—é—â–∏–µ 15% –≤—ã—Ä—É—á–∫–∏  
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è C: –æ—Å—Ç–∞–ª—å–Ω—ã–µ 50%, –¥–∞—é—â–∏–µ 5% –≤—ã—Ä—É—á–∫–∏
4. –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π actionable —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–¥–µ–ª–∞—Ç—å).
5. –ß–∏—Å–ª–∞ –æ–∫—Ä—É–≥–ª—è–π –¥–æ —Ü–µ–ª—ã—Ö, –µ—Å–ª–∏ —ç—Ç–æ —Ä—É–±–ª–∏. –ü—Ä–æ—Ü–µ–Ω—Ç—ã ‚Äî –¥–æ 1 –∑–Ω–∞–∫–∞.
6. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –¥–ª—è Telegram (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown).
7. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –æ—Ç—á—ë—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—ã—Ä—É—á–∫—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞.
8. –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date}
"""


class ClaudeAnalytics:
    """–ê–Ω–∞–ª–∏—Ç–∏–∫ –Ω–∞ –±–∞–∑–µ Claude –¥–ª—è –¥–∞–Ω–Ω—ã—Ö iiko"""

    def __init__(self, api_key: str, model: str = "claude-sonnet-4-20250514"):
        self.client = anthropic.Anthropic(api_key=api_key)
        self.model = model

    def analyze(self, question: str, iiko_data: str) -> str:
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å + –¥–∞–Ω–Ω—ã–µ iiko –≤ Claude –∏ –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä. "–ö–∞–∫–∞—è –≤—ã—Ä—É—á–∫–∞ –∑–∞ –≤—á–µ—Ä–∞?")
            iiko_data: –î–∞–Ω–Ω—ã–µ –∏–∑ iiko –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        
        Returns:
            –û—Ç–≤–µ—Ç Claude —Å –∞–Ω–∞–ª–∏–∑–æ–º
        """
        current_date = datetime.now().strftime("%d.%m.%Y %H:%M")
        system = SYSTEM_PROMPT.format(current_date=current_date)

        user_message = (
            f"–í–æ–ø—Ä–æ—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: {question}\n\n"
            f"‚ïê‚ïê‚ïê –î–ê–ù–ù–´–ï –ò–ó IIKO ‚ïê‚ïê‚ïê\n"
            f"{iiko_data}\n"
            f"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
            f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å. "
            f"–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º."
        )

        try:
            response = self.client.messages.create(
                model=self.model,
                max_tokens=2000,
                system=system,
                messages=[
                    {"role": "user", "content": user_message}
                ]
            )
            return response.content[0].text
        except anthropic.APIError as e:
            logger.error(f"Claude API –æ—à–∏–±–∫–∞: {e}")
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏: {e.message}"
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}"

    def quick_analyze(self, data: str, task: str) -> str:
        """–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–¥–ª—è –æ—Ç—á—ë—Ç–æ–≤)"""
        return self.analyze(question=task, iiko_data=data)
